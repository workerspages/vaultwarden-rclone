<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaultwarden Backup æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .login-card { max-width: 400px; margin: 80px auto; }
        .auth-card { max-width: 450px; margin: 80px auto; }
        .log-box { background: #212529; color: #00ff00; font-family: monospace; height: 300px; overflow-y: scroll; padding: 10px; font-size: 0.9em; }
        .table-files { font-size: 0.9em; }
        .btn-xs { font-size: 0.8rem; padding: 0.1rem 0.4rem; }
    </style>
</head>
<body>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- ç™»å½•/2FA è®¾ç½®/2FA éªŒè¯ é¡µé¢ä¿æŒä¸å˜ (çœç•¥) ... è¯·ä¿ç•™ä¹‹å‰çš„ä»£ç  -->
{% if page == 'login' %}
<div class="container">
    <div class="card login-card shadow">
        <div class="card-header bg-primary text-white">ğŸ” ç™»å½•æ§åˆ¶å°</div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('login') }}">
                <div class="mb-3"><label>ç”¨æˆ·å</label><input type="text" name="username" class="form-control" required></div>
                <div class="mb-3"><label>å¯†ç </label><input type="password" name="password" class="form-control" required></div>
                <button type="submit" class="btn btn-primary w-100">ä¸‹ä¸€æ­¥</button>
            </form>
        </div>
    </div>
</div>
{% elif page == '2fa_setup' %}
<div class="container">
    <div class="card auth-card shadow">
        <div class="card-header bg-warning text-dark">âš ï¸ é¦–æ¬¡è®¾ç½®ä¸¤æ­¥éªŒè¯ (2FA)</div>
        <div class="card-body text-center">
            <p class="small text-muted">è¯·ä½¿ç”¨ Authenticator æ‰«æä¸‹æ–¹äºŒç»´ç ã€‚</p>
            <img src="data:image/png;base64,{{ qr_code }}" class="img-fluid mb-3" style="max-width: 200px;">
            <p class="small mb-1">æ‰‹åŠ¨å¯†é’¥ï¼š</p><code class="d-block mb-3 bg-light p-2 user-select-all">{{ secret }}</code>
            <form method="POST" action="{{ url_for('verify_2fa') }}">
                <div class="input-group mb-3">
                    <input type="text" name="code" class="form-control text-center" placeholder="6 ä½éªŒè¯ç " required>
                    <button type="submit" class="btn btn-success">å¯ç”¨</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% elif page == '2fa_verify' %}
<div class="container">
    <div class="card login-card shadow">
        <div class="card-header bg-success text-white">ğŸ›¡ï¸ ä¸¤æ­¥éªŒè¯</div>
        <div class="card-body text-center">
            <form method="POST" action="{{ url_for('verify_2fa') }}">
                <div class="mb-3"><input type="text" name="code" class="form-control text-center fs-4" placeholder="000000" required autofocus></div>
                <button type="submit" class="btn btn-success w-100">éªŒè¯ç™»å½•</button>
            </form>
            <a href="{{ url_for('logout') }}" class="btn btn-link btn-sm mt-3">å–æ¶ˆ</a>
        </div>
    </div>
</div>

<!-- ä»ªè¡¨ç›˜ -->
{% elif page == 'dashboard' %}
<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">Vaultwarden Backup</span>
        <div>
            <!-- Tunnel çŠ¶æ€ -->
            {% if has_tunnel %}
            <span class="badge bg-primary me-2">ğŸš‡ Tunnel å·²é…ç½®</span>
            {% endif %}
            
            {% if has_2fa %}
            <span class="badge bg-success me-2">ğŸ›¡ï¸ 2FA å·²å¼€å¯</span>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">é€€å‡º</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <!-- å·¦ä¾§ -->
        <div class="col-md-5">
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">âš¡ å¿«é€Ÿæ“ä½œ</div>
                <div class="card-body">
                    <form method="POST" class="d-grid gap-2">
                        <button type="submit" name="action" value="backup" class="btn btn-primary">ğŸš€ ç«‹å³è§¦å‘å¤‡ä»½</button>
                        <button type="submit" name="action" value="restore_latest" class="btn btn-warning" onclick="return confirm('ç¡®å®šè¦è¿˜åŸå—ï¼Ÿ')">ğŸ”„ è¿˜åŸæœ€æ–°å¤‡ä»½</button>
                    </form>
                    <hr>
                    <h6 class="mb-2">ğŸ“¥ æœ¬åœ°ä¸Šä¼ è¿˜åŸ</h6>
                    <form action="{{ url_for('upload_restore') }}" method="POST" enctype="multipart/form-data" class="input-group">
                        <input type="file" name="file" class="form-control" required>
                        <button type="submit" class="btn btn-danger" onclick="return confirm('ç¡®å®šè¦è¿˜åŸæ­¤æ–‡ä»¶å—ï¼Ÿ')">è¿˜åŸ</button>
                    </form>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">ğŸ“„ ç³»ç»Ÿæ—¥å¿—</div>
                <div class="card-body p-0">
                    <div class="log-box" id="logBox">{{ logs }}</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ -->
        <div class="col-md-7">
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>â˜ï¸ äº‘ç«¯å¤‡ä»½æ–‡ä»¶</span>
                    <a href="{{ url_for('index') }}" class="btn btn-sm btn-light py-0">åˆ·æ–°</a>
                </div>
                <div class="card-body p-0">
                    {% if remote_files %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-hover table-sm table-files mb-0 align-middle">
                            <thead class="table-light sticky-top">
                                <tr><th>æ–‡ä»¶å</th><th>æ—¶é—´</th><th>å¤§å°</th><th class="text-end">æ“ä½œ</th></tr>
                            </thead>
                            <tbody>
                                {% for file in remote_files %}
                                <tr>
                                    <td class="text-truncate" style="max-width: 150px;" title="{{ file.Name }}">{{ file.Name }}</td>
                                    <td>{{ file.ModTime }}</td>
                                    <td>{{ file.SizeHuman }}</td>
                                    <td class="text-end">
                                        <a href="{{ url_for('download_file', filename=file.Name) }}" class="btn btn-xs btn-outline-primary" target="_blank">ä¸‹è½½</a>
                                        <form action="{{ url_for('restore_file') }}" method="POST" style="display:inline-block;">
                                            <input type="hidden" name="filename" value="{{ file.Name }}">
                                            <button type="submit" class="btn btn-xs btn-outline-danger" onclick="return confirm('ç¡®å®šè¿˜åŸï¼Ÿ')">è¿˜åŸ</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            {% if config.RCLONE_REMOTE %}æš‚æ— æ–‡ä»¶æˆ–è¿æ¥è¶…æ—¶{% else %}è¯·å…ˆé…ç½® RCLONE_REMOTE{% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- é…ç½® -->
            <div class="card shadow">
                <div class="card-header bg-info text-white" role="button" data-bs-toggle="collapse" data-bs-target="#configCollapse">
                    âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®
                </div>
                <div class="collapse" id="configCollapse">
                    <div class="card-body">
                        <form method="POST">
                            <input type="hidden" name="action" value="save">
                            <div class="mb-3"><label class="form-label">Rclone Remote</label><input type="text" name="RCLONE_REMOTE" class="form-control" value="{{ config.RCLONE_REMOTE }}"></div>
                            <div class="mb-3">
                                <label class="form-label">Rclone Config Base64</label>
                                {% if has_rclone_conf %}<div class="alert alert-success py-2 mb-0">âœ… å·²åŠ è½½é…ç½®</div>{% else %}<div class="alert alert-warning py-2 mb-0">âš ï¸ æœªæ£€æµ‹åˆ°é…ç½®</div>{% endif %}
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3"><label class="form-label">Cron</label><input type="text" name="BACKUP_CRON" class="form-control" value="{{ config.BACKUP_CRON }}"></div>
                                <div class="col-6 mb-3"><label class="form-label">å‹ç¼©</label><select name="BACKUP_COMPRESSION" class="form-select"><option value="gz" {% if config.BACKUP_COMPRESSION=='gz' %}selected{% endif %}>Gzip</option><option value="zst" {% if config.BACKUP_COMPRESSION=='zst' %}selected{% endif %}>Zstd</option></select></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ä¿ç•™ç­–ç•¥</label>
                                <select name="RETENTION_MODE" class="form-select">
                                    <option value="smart" {% if config.RETENTION_MODE=='smart' %}selected{% endif %}>æ™ºèƒ½ç­–ç•¥ (Smart)</option>
                                    <option value="days" {% if config.RETENTION_MODE=='days' %}selected{% endif %}>æŒ‰å¤©æ•° (Days)</option>
                                    <option value="count" {% if config.RETENTION_MODE=='count' %}selected{% endif %}>æŒ‰æ•°é‡ (Count)</option>
                                    <option value="forever" {% if config.RETENTION_MODE=='forever' %}selected{% endif %}>æ°¸ä¹…ä¿ç•™ (Forever)</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3"><label class="form-label">ä¿ç•™å¤©æ•°</label><input type="number" name="BACKUP_RETAIN_DAYS" class="form-control" value="{{ config.BACKUP_RETAIN_DAYS }}"></div>
                                <div class="col-6 mb-3"><label class="form-label">ä¿ç•™æ•°é‡</label><input type="number" name="BACKUP_RETAIN_COUNT" class="form-control" value="{{ config.BACKUP_RETAIN_COUNT }}"></div>
                            </div>

                            <!-- Tunnel Token -->
                            <div class="mb-3">
                                <label class="form-label">Cloudflare Tunnel Token (å¯é€‰)</label>
                                <input type="text" name="CLOUDFLARED_TOKEN" class="form-control" value="{{ config.CLOUDFLARED_TOKEN }}" placeholder="eyJhIjoi...">
                                <div class="form-text">å¡«å…¥ Token åä¿å­˜å¹¶é‡å¯å®¹å™¨ä»¥å¯åŠ¨ Tunnelã€‚</div>
                            </div>

                            <div class="d-flex justify-content-between mt-3">
                                <button type="submit" class="btn btn-primary flex-grow-1 me-2">ğŸ’¾ ä¿å­˜é…ç½® (éœ€é‡å¯)</button>
                                <button type="submit" name="action" value="reset_2fa" class="btn btn-outline-danger" onclick="return confirm('ç¡®å®šé‡ç½® 2FAï¼Ÿ')">é‡ç½® 2FA</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var logBox = document.getElementById("logBox");
    if(logBox) logBox.scrollTop = logBox.scrollHeight;
</script>
</body>
</html>
