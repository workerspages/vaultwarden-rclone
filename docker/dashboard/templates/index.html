<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaultwarden Backup æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .login-card { max-width: 400px; margin: 100px auto; }
        .log-box { background: #212529; color: #00ff00; font-family: monospace; height: 300px; overflow-y: scroll; padding: 10px; font-size: 0.9em; }
        .table-files { font-size: 0.9em; }
        .nav-brand { font-weight: bold; }
    </style>
</head>
<body>

{% if login_page %}
<div class="container">
    <div class="card login-card shadow">
        <div class="card-header bg-primary text-white">ç™»å½•æ§åˆ¶å°</div>
        <div class="card-body">
            {% with messages = get_flashed_messages() %}
              {% if messages %}<div class="alert alert-danger">{{ messages[0] }}</div>{% endif %}
            {% endwith %}
            <form method="POST">
                <div class="mb-3">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>å¯†ç </label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">ç™»å½•</button>
            </form>
        </div>
    </div>
</div>
{% else %}

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">Vaultwarden Backup Dashboard</span>
        <a href="/logout" class="btn btn-outline-light btn-sm">é€€å‡º</a>
    </div>
</nav>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row">
        <!-- å·¦ä¾§ï¼šæ“ä½œä¸æ—¥å¿— -->
        <div class="col-md-5">
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">âš¡ å¿«é€Ÿæ“ä½œ</div>
                <div class="card-body">
                    <form method="POST" class="d-grid gap-2">
                        <button type="submit" name="action" value="backup" class="btn btn-primary">ğŸš€ ç«‹å³è§¦å‘å¤‡ä»½</button>
                        <button type="submit" name="action" value="restore_latest" class="btn btn-warning" onclick="return confirm('ç¡®å®šè¦ä»äº‘ç«¯è¿˜åŸæœ€æ–°å¤‡ä»½å—ï¼Ÿè¿™ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼')">ğŸ”„ è¿˜åŸäº‘ç«¯æœ€æ–°å¤‡ä»½</button>
                    </form>
                    
                    <hr>
                    
                    <h6 class="mb-2">ğŸ“¥ æœ¬åœ°ä¸Šä¼ è¿˜åŸ</h6>
                    <form action="/upload_restore" method="POST" enctype="multipart/form-data" class="input-group">
                        <input type="file" name="file" class="form-control" required>
                        <button type="submit" class="btn btn-danger" onclick="return confirm('ç¡®å®šè¦ä½¿ç”¨æ­¤æ–‡ä»¶è¦†ç›–å½“å‰æ•°æ®å—ï¼Ÿ')">è¿˜åŸ</button>
                    </form>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">ğŸ“„ ç³»ç»Ÿæ—¥å¿—</div>
                <div class="card-body p-0">
                    <div class="log-box" id="logBox">{{ logs }}</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ–‡ä»¶åˆ—è¡¨ä¸é…ç½® -->
        <div class="col-md-7">
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span>â˜ï¸ äº‘ç«¯å¤‡ä»½æ–‡ä»¶</span>
                    <a href="/" class="btn btn-sm btn-light py-0">åˆ·æ–°</a>
                </div>
                <div class="card-body p-0">
                    {% if remote_files %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-hover table-sm table-files mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>æ–‡ä»¶å</th>
                                    <th>æ—¶é—´</th>
                                    <th>å¤§å°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in remote_files %}
                                <tr>
                                    <td>{{ file.Name }}</td>
                                    <td>{{ file.ModTime }}</td>
                                    <td>{{ file.SizeHuman }}</td>
                                    <td>
                                        <a href="/download/{{ file.Name }}" class="btn btn-xs btn-outline-primary btn-sm py-0" target="_blank">ä¸‹è½½</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            {% if config.RCLONE_REMOTE %}
                                æš‚æ— æ–‡ä»¶æˆ–è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ Rclone é…ç½®ã€‚
                            {% else %}
                                è¯·å…ˆé…ç½® RCLONE_REMOTEã€‚
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- ç¯å¢ƒå˜é‡é…ç½® -->
            <div class="card shadow">
                <div class="card-header bg-info text-white" role="button" data-bs-toggle="collapse" data-bs-target="#configCollapse">
                    âš™ï¸ ç¯å¢ƒå˜é‡é…ç½® (ç‚¹å‡»å±•å¼€)
                </div>
                <div class="collapse show" id="configCollapse">
                    <div class="card-body">
                        <form method="POST">
                            <input type="hidden" name="action" value="save">
                            
                            <h6 class="border-bottom pb-2 mb-3">å­˜å‚¨ä¸å‹ç¼©</h6>
                            <div class="mb-3">
                                <label class="form-label">Rclone Remote</label>
                                <input type="text" name="RCLONE_REMOTE" class="form-control" value="{{ config.RCLONE_REMOTE }}" placeholder="onedrive:/backup">
                            </div>
                            
                            <!-- Rclone Config Base64 å±•ç¤ºåŒºåŸŸ (åªè¯») -->
                            <div class="mb-3">
                                <label class="form-label">Rclone Config Base64</label>
                                {% if has_rclone_conf %}
                                    <div class="alert alert-success py-2 mb-0">
                                        âœ… å·²é€šè¿‡ç³»ç»Ÿç¯å¢ƒå˜é‡ (ENV) æˆåŠŸåŠ è½½é…ç½®
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning py-2 mb-0">
                                        âš ï¸ æœªæ£€æµ‹åˆ°ç¯å¢ƒå˜é‡ RCLONE_CONF_BASE64ï¼Œè¯·åœ¨éƒ¨ç½²å¹³å°è®¾ç½®
                                    </div>
                                {% endif %}
                                <div class="form-text">ä¸ºäº†å®‰å…¨å’Œç¨³å®šï¼Œè¯·åœ¨ Zeabur/Docker ç¯å¢ƒå˜é‡ä¸­ç›´æ¥è®¾ç½®æ­¤é¡¹ã€‚</div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Cron è¡¨è¾¾å¼</label>
                                    <input type="text" name="BACKUP_CRON" class="form-control" value="{{ config.BACKUP_CRON }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å‹ç¼©æ ¼å¼</label>
                                    <select name="BACKUP_COMPRESSION" class="form-select">
                                        <option value="gz" {% if config.BACKUP_COMPRESSION == 'gz' %}selected{% endif %}>Gzip (gz)</option>
                                        <option value="zst" {% if config.BACKUP_COMPRESSION == 'zst' %}selected{% endif %}>Zstandard (zst)</option>
                                    </select>
                                </div>
                            </div>

                            <h6 class="border-bottom pb-2 mb-3 mt-3">ğŸ—‘ï¸ å¤‡ä»½ä¿ç•™ç­–ç•¥</h6>
                            <div class="mb-3">
                                <select name="RETENTION_MODE" id="retentionMode" class="form-select" onchange="updateRetentionUI()">
                                    <option value="smart" {% if config.RETENTION_MODE == 'smart' %}selected{% endif %}>ğŸ§  æ™ºèƒ½å¤‡ä»½ä¿ç•™ç­–ç•¥ (GFS)</option>
                                    <option value="days" {% if config.RETENTION_MODE == 'days' %}selected{% endif %}>ğŸ“… åˆ é™¤æ—©äºæŒ‡å®šæ—¥æœŸçš„å¤‡ä»½</option>
                                    <option value="count" {% if config.RETENTION_MODE == 'count' %}selected{% endif %}>ğŸ”¢ ä¿ç•™æŒ‡å®šæ•°ç›®çš„å¤‡ä»½</option>
                                    <option value="forever" {% if config.RETENTION_MODE == 'forever' %}selected{% endif %}>â™¾ï¸ æ°¸ä¹…ä¿ç•™å¤‡ä»½</option>
                                </select>
                            </div>
                            
                            <div class="alert alert-light border small text-muted mb-3" id="desc-smart" style="display:none;">
                                éšç€æ—¶é—´æ¨ç§»ï¼Œå¤‡ä»½å°†è¢«è‡ªåŠ¨æ¸…ç†ã€‚ç³»ç»Ÿå°†ä¿ç•™ï¼š<br>
                                â€¢ æœ€è¿‘ <strong>7 å¤©</strong> ä¸­æ¯å¤©ä¸€ä»½<br>
                                â€¢ æœ€è¿‘ <strong>4 å‘¨</strong> ä¸­æ¯å‘¨ä¸€ä»½<br>
                                â€¢ æœ€è¿‘ <strong>12 ä¸ªæœˆ</strong> ä¸­æ¯æœˆä¸€ä»½<br>
                                åŒæ—¶ï¼Œä¿è¯æ€»æ˜¯è‡³å°‘å­˜åœ¨ä¸€ä¸ªæœ€æ–°çš„å¤‡ä»½ã€‚
                            </div>
                            
                            <div class="mb-3" id="input-days" style="display:none;">
                                <label class="form-label">ä¿ç•™å¤©æ•°</label>
                                <input type="number" name="BACKUP_RETAIN_DAYS" class="form-control" value="{{ config.BACKUP_RETAIN_DAYS }}">
                            </div>
                            
                            <div class="mb-3" id="input-count" style="display:none;">
                                <label class="form-label">ä¿ç•™æ•°é‡</label>
                                <input type="number" name="BACKUP_RETAIN_COUNT" class="form-control" value="{{ config.BACKUP_RETAIN_COUNT }}">
                            </div>

                            <h6 class="border-bottom pb-2 mb-3 mt-3">Telegram é€šçŸ¥</h6>
                            <div class="mb-3 form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="TELEGRAM_ENABLED" value="true" {% if config.TELEGRAM_ENABLED == 'true' %}checked{% endif %}>
                                <label class="form-check-label">å¯ç”¨é€šçŸ¥</label>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <input type="text" name="TELEGRAM_BOT_TOKEN" class="form-control" placeholder="Bot Token" value="{{ config.TELEGRAM_BOT_TOKEN }}">
                                </div>
                                <div class="col-6 mb-3">
                                    <input type="text" name="TELEGRAM_CHAT_ID" class="form-control" placeholder="Chat ID" value="{{ config.TELEGRAM_CHAT_ID }}">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mt-2">ğŸ’¾ ä¿å­˜é…ç½® (éœ€é‡å¯ç”Ÿæ•ˆ)</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var logBox = document.getElementById("logBox");
    if(logBox) logBox.scrollTop = logBox.scrollHeight;

    function updateRetentionUI() {
        var mode = document.getElementById("retentionMode").value;
        document.getElementById("desc-smart").style.display = (mode === 'smart') ? 'block' : 'none';
        document.getElementById("input-days").style.display = (mode === 'days') ? 'block' : 'none';
        document.getElementById("input-count").style.display = (mode === 'count') ? 'block' : 'none';
    }
    // åˆå§‹åŒ–
    updateRetentionUI();
</script>
</body>
</html>
